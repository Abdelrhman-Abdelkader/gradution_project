name: $(Date:yyyyMMdd)$(Rev:.r)-Infrastructure
trigger: none
pr: none

parameters:
- name: env
  type: string
  default: nonprod
  values: [nonprod, prod]

- name: destroy
  type: boolean
  default: false

variables:
  TF_DIR: .
  TF_VAR_FILE: ${{ parameters.env }}.tfvars
  AWS_SERVICE_CONNECTION: 3body-pipline
  AWS_REGION: ap-southeast-2
  TF_VERSION: 1.6.6

pool:
  vmImage: ubuntu-latest

jobs:
- job: Infrastructure
  steps:
  - checkout: self

  - task: AWSShellScript@1
    displayName: Install Terraform
    inputs:
      awsCredentials: 3body-pipline
      regionName: ap-southeast-2
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        cd /tmp
        curl -fsSLo terraform.zip "https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip"
        unzip -o terraform.zip
        sudo mv terraform /usr/local/bin/terraform
        terraform version

  - task: AWSShellScript@1
    displayName: Terraform Init
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: ap-southeast-2
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        cd "$TF_DIR"
        terraform init

  - task: AWSShellScript@1
    displayName: Terraform Apply or Destroy
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: ap-southeast-2
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        cd "$TF_DIR"
        terraform validate

        if [ "${{ parameters.destroy }}" = "true" ]; then
          terraform destroy -auto-approve -var-file="$(TF_VAR_FILE)"
        else
          terraform apply -auto-approve -var-file="$(TF_VAR_FILE)"
        fi
